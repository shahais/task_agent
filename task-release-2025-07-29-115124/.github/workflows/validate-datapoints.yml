name: SWE-bench Data Point Validator with Official API

on:
  pull_request:
    paths:
      - 'data_points/**/*.json'
  push:
    branches: [main]
    paths:
      - 'data_points/**/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential
    
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
    
    - name: Install SWE-bench and dependencies
      run: |
        uv pip install --system swebench
        uv pip install --system docker requests tqdm
    
    - name: Verify Docker and SWE-bench setup
      run: |
        docker --version
        docker ps
        python -c "import swebench; print(f'SWE-bench {swebench.__version__} готов')"
        python -c "from swebench.harness.run_evaluation import main; print('API доступен')"
        echo "Настройка завершена"
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          data_points/**/*.json
    
    - name: Quick Structure Validation
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        python validator.py --no-evaluation --verbose ${{ steps.changed-files.outputs.all_changed_files }}
        echo "Структурная проверка пройдена"
    
    - name: Official SWE-bench Evaluation
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "Запуск ОФИЦИАЛЬНОГО SWE-bench evaluation с Docker:"
        echo "Это может занять до 30 минут (Docker + установка зависимостей)..."
        
        FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Запускаем валидатор с официальным SWE-bench API
        echo "Файлы для валидации: $FILES"
        python validator.py --verbose --timeout 3600 $FILES
        
        VALIDATION_EXIT_CODE=$?
        
        if [ $VALIDATION_EXIT_CODE -eq 0 ]; then
          echo "ВСЕ data points прошли официальную SWE-bench evaluation!"
        else
          echo "Некоторые data points НЕ ПРОШЛИ официальную SWE-bench evaluation"
          exit 1
        fi
