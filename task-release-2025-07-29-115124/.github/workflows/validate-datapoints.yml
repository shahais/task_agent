name: SWE-bench Data Point Validator with Official API

on:
  pull_request:
    paths:
      - 'data_points/**/*.json'
  push:
    branches: [main]
    paths:
      - 'data_points/**/*.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½ Ğ´Ğ»Ñ Docker Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install UV
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git build-essential
    
    - name: Setup Docker
      uses: docker/setup-buildx-action@v3
    
    - name: Install SWE-bench and dependencies
      run: |
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ SWE-bench
        uv pip install --system swebench
        
        # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        uv pip install --system docker requests tqdm
    
    - name: Verify Docker and SWE-bench setup
      run: |
        docker --version
        docker ps
        python -c "import swebench; print(f'SWE-bench {swebench.__version__} Ğ³Ğ¾Ñ‚Ğ¾Ğ²')"
        python -c "from swebench.harness.run_evaluation import main; print('API Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½')"
        echo "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° âœ…"
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          data_points/**/*.json
    
    - name: Quick Structure Validation
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ” Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° (Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾)
        python validator.py --no-evaluation --verbose ${{ steps.changed-files.outputs.all_changed_files }}
        
        echo "âœ… Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ°"
    
    - name: Official SWE-bench Evaluation
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞĞ“Ğ SWE-bench evaluation Ñ Docker:"
        echo "âš ï¸  Ğ­Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ´Ğ¾ 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚ (Docker + ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹)..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ‚Ğ¾Ñ€ Ñ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ SWE-bench API
        echo "Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸: $FILES"
        
        # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ´Ğ»Ñ Docker Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
        python validator.py --verbose --timeout 3600 $FILES
        
        VALIDATION_EXIT_CODE=$?
        
        if [ $VALIDATION_EXIT_CODE -eq 0 ]; then
          echo "âœ… Ğ’Ğ¡Ğ• data points Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½ÑƒÑ SWE-bench evaluation!"
        else
          echo "âŒ ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ data points ĞĞ• ĞŸĞ ĞĞ¨Ğ›Ğ˜ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½ÑƒÑ SWE-bench evaluation"
          exit 1
        fi
    
    - name: Generate Validation Report
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ“Š Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸:"
        
        FILES="${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ JSON Ğ¾Ñ‚Ñ‡ĞµÑ‚
        python validator.py --json --verbose $FILES > validation_report.json
        
        echo "ğŸ“‹ ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚:"
        python -c "
        import json
        with open('validation_report.json') as f:
            results = json.load(f)
        
        print(f'Ğ’ÑĞµĞ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: {len(results)}')
        
        valid_count = sum(1 for r in results if r['valid'])
        print(f'Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ñ…: {valid_count}/{len(results)}')
        
        for result in results:
            file_name = result['file']
            status = 'âœ… VALID' if result['valid'] else 'âŒ INVALID'
            print(f'{status}: {file_name}')
            
            if result.get('swe_bench_evaluation'):
                swe = result['swe_bench_evaluation']
                if swe.get('patch_applied'):
                    print(f'  ğŸ”§ ĞŸĞ°Ñ‚Ñ‡ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½: âœ…')
                else:
                    print(f'  ğŸ”§ ĞŸĞ°Ñ‚Ñ‡ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½: âŒ')
                
                if swe.get('tests_passed'):
                    print(f'  ğŸ§ª Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹: âœ…')
                else:
                    print(f'  ğŸ§ª Ğ¢ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹: âŒ')
                
                fail_to_pass = swe.get('fail_to_pass_results', {})
                if fail_to_pass:
                    passed = sum(1 for r in fail_to_pass.values() if r['passed'])
                    total = len(fail_to_pass)
                    emoji = 'âœ…' if passed == total else 'âŒ'
                    print(f'  ğŸ“ˆ FAIL_TO_PASS: {passed}/{total} {emoji}')
                
                pass_to_pass = swe.get('pass_to_pass_results', {})
                if pass_to_pass:
                    passed = sum(1 for r in pass_to_pass.values() if r['passed'])
                    total = len(pass_to_pass)
                    emoji = 'âœ…' if passed == total else 'âŒ'
                    print(f'  ğŸ“Š PASS_TO_PASS: {passed}/{total} {emoji}')
        "
        
        echo ""
        echo "ğŸ‰ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ»ÑÑ ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ™ SWE-bench evaluation harness!"
        echo "ğŸ³ Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ»Ğ¸ÑÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸"
        echo "ğŸ“¦ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°Ğ»Ğ¸ÑÑŒ Ğ² Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… ÑÑ€ĞµĞ´Ğ°Ñ…"
